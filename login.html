<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بوابة الدخول الموحدة - أداة علم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .loader { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-btn.active { color: #4f46e5; border-bottom: 2px solid #4f46e5; background: #eef2ff; }
        /* لتجنب تداخل الأيقونة مع النص */
        #login-pass, #reg-pass { padding-left: 2.5rem; } 
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white w-full max-w-md rounded-2xl shadow-xl overflow-hidden">
        
        <div class="bg-indigo-600 p-6 text-center">
            <h1 class="text-2xl font-bold text-white mb-1">أداة علم</h1>
            <p class="text-indigo-200 text-sm">بوابتك التعليمية الموحدة</p>
        </div>

        <div class="flex border-b">
            <button id="tab-login" class="tab-btn active w-1/2 py-4 font-bold text-gray-500 hover:bg-gray-50 transition">تسجيل الدخول</button>
            <button id="tab-register" class="tab-btn w-1/2 py-4 font-bold text-gray-500 hover:bg-gray-50 transition">إنشاء حساب</button>
        </div>

        <form id="login-form" class="p-8 space-y-5">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">البريد الإلكتروني</label>
                <div class="relative">
                    <i class="fas fa-envelope absolute top-3 right-3 text-gray-400"></i>
                    <input type="email" id="login-email" required class="w-full pr-10 pl-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">كلمة المرور</label>
                <div class="relative">
                    <i class="fas fa-lock absolute top-3 right-3 text-gray-400"></i>
                    
                    <input type="password" id="login-pass" required class="w-full pr-10 pl-10 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    
                    <button type="button" id="toggle-login-pass" class="absolute top-3 left-3 text-gray-400 hover:text-indigo-600 focus:outline-none transition">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                
                <div class="flex justify-between items-center mt-3">
                    <div class="flex items-center">
                        <input id="remember-me" type="checkbox" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="remember-me" class="mr-2 block text-sm text-gray-900 cursor-pointer">
                            تذكرني
                        </label>
                    </div>
                    
                    <a href="#" id="forgot-pass" class="text-xs text-indigo-600 hover:underline">نسيت كلمة المرور؟</a>
                </div>
            </div>
            
            <button type="submit" id="btn-login" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition flex justify-center items-center gap-2">
                <span>دخول</span>
                <div class="loader hidden"></div>
            </button>
        </form>

        <form id="register-form" class="p-8 space-y-4 hidden">
            <div class="grid grid-cols-2 gap-3">
                <input type="text" id="reg-name" placeholder="الاسم الكامل" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                <input type="tel" id="reg-phone" placeholder="رقم الهاتف" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>
            <input type="email" id="reg-email" placeholder="البريد الإلكتروني" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
            
            <div>
                <select id="reg-spec" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white mb-2">
                    <option value="" disabled selected>اختر التخصص</option>
                    <option value="طب بشري">طب بشري</option>
                    <option value="طب بشري واعلام آلي">طب بشري واعلام آلي</option>
                    <option value="طب أسنان">طب أسنان</option>
                    <option value="صيدلة">صيدلة</option>
                    <option value="شبه طبي">شبه طبي</option>
                    <option value="other">تخصص آخر (أكتبه يدوياً)</option>
                </select>
                <input type="text" id="reg-spec-other" placeholder="اكتب تخصصك هنا..." class="hidden w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-gray-50">
            </div>

            <div class="relative">
                <input type="password" id="reg-pass" placeholder="كلمة المرور (6 أحرف)" required minlength="6" class="w-full pr-4 pl-10 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                
                <button type="button" id="toggle-reg-pass" class="absolute top-2.5 left-3 text-gray-400 hover:text-green-600 focus:outline-none transition">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            
            <button type="submit" id="btn-register" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition flex justify-center items-center gap-2">
                <span>إنشاء حساب</span>
                <div class="loader hidden"></div>
            </button>
        </form>

        <div id="msg-box" class="hidden p-4 text-center text-sm font-bold"></div>
    </div>


<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // تم التأكد من استيراد setPersistence
        import { getAuth, setPersistence, browserLocalPersistence, browserSessionPersistence, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, sendPasswordResetEmail, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDAEbxYuAHu5stGx5c02VbgsUKBhoidTeA",
            authDomain: "informationpassmemberessystem.firebaseapp.com",
            projectId: "informationpassmemberessystem",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- متغيرات خاصة بحفظ البريد الإلكتروني ---
        const loginEmailInput = document.getElementById('login-email');
        const rememberMeCheckbox = document.getElementById('remember-me');
        const REMEMBER_ME_KEY = 'rememberedEmail';

        // دالة تحميل البريد الإلكتروني المحفوظ عند فتح الصفحة
        function loadRememberedEmail() {
            const rememberedEmail = localStorage.getItem(REMEMBER_ME_KEY);
            if (rememberedEmail) {
                loginEmailInput.value = rememberedEmail;
                rememberMeCheckbox.checked = true; // تحديد مربع الاختيار
            }
        }
        
        // تحميل البريد الإلكتروني عند تشغيل السكربت
        loadRememberedEmail();
        // ------------------------------------------
        
        // --- ميزة إظهار/إخفاء كلمة المرور ---
        function setupPasswordToggle(inputId, toggleId) {
            const input = document.getElementById(inputId);
            const btn = document.getElementById(toggleId);
            const icon = btn.querySelector('i');

            btn.addEventListener('click', () => {
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });
        }

        setupPasswordToggle('login-pass', 'toggle-login-pass');
        setupPasswordToggle('reg-pass', 'toggle-reg-pass');


        // --- Logic for "Other" Specialization Toggle ---
        const specSelect = document.getElementById('reg-spec');
        const otherInput = document.getElementById('reg-spec-other');

        specSelect.addEventListener('change', function() {
            if (this.value === 'other') {
                otherInput.classList.remove('hidden');
                otherInput.required = true;
            } else {
                otherInput.classList.add('hidden');
                otherInput.required = false;
                otherInput.value = '';
            }
        });

        // --- Smart Routing System (Prioritizes ?redirect= URL parameter) ---
        async function smartRedirect(user) {
            const msgBox = document.getElementById('msg-box');
            msgBox.textContent = "جاري توجيهك حسب تخصصك...";
            msgBox.className = "p-4 text-center text-sm font-bold bg-indigo-100 text-indigo-700 block";

            const urlParams = new URLSearchParams(window.location.search);
            const redirectUrl = urlParams.get('redirect');
            
            // 1. الأولوية لرابط التوجيه القادم من الصفحة السابقة
            if (redirectUrl) {
                window.location.href = redirectUrl;
                return;
            }

            // 2. التوجيه الافتراضي بناءً على التخصص في قاعدة البيانات
            try {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                let targetUrl = 'adatealm_med_intro.html'; 
                
                if (userDoc.exists()) {
                    const spec = userDoc.data().specialization;
                    switch(spec) {
                        case 'طب أسنان':
                            targetUrl = 'adatealm_dent_intro.html';
                            break;
                        case 'صيدلة':
                            targetUrl = 'adatealm_pharma_intro.html'; 
                            break;
                        case 'شبه طبي':
                            targetUrl = 'adatealm_paramedical_intro.html';
                            break;
                        default:
                            targetUrl = 'adatealm_med_intro.html';
                            break;
                    }
                }
                
                window.location.href = targetUrl;

            } catch (error) {
                console.error("Redirect Error:", error);
                window.location.href = 'adatealm_med_intro.html'; 
            }
        }

        // --- UI Logic ---
        const loginForm = document.getElementById('login-form');
        const regForm = document.getElementById('register-form');
        const tabLogin = document.getElementById('tab-login');
        const tabReg = document.getElementById('tab-register');

        tabLogin.onclick = () => {
            loginForm.classList.remove('hidden');
            regForm.classList.add('hidden');
            tabLogin.classList.add('active');
            tabReg.classList.remove('active');
        };

        tabReg.onclick = () => {
            regForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
            tabReg.classList.add('active');
            tabLogin.classList.remove('active');
        };

        function showMsg(msg, type) {
            const box = document.getElementById('msg-box');
            box.innerHTML = msg; // استخدام innerHTML لدعم تنسيق Bold
            box.className = `p-4 text-center text-sm font-bold block ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            const duration = type === 'success' && msg.includes('SPAM') ? 7000 : 4000;
            setTimeout(() => box.classList.add('hidden'), duration);
        }

        // --- Login Handler (FINAL FIX: Implemented Email Persistence alongside Auth Persistence) ---
        loginForm.onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-login');
            const loader = btn.querySelector('.loader');
            // استخدام متغير loginEmailInput لضمان قراءة القيمة الحالية
            const email = loginEmailInput.value; 
            const pass = document.getElementById('login-pass').value;
            
            const rememberMe = rememberMeCheckbox.checked;
            const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
            
            btn.disabled = true;
            loader.classList.remove('hidden');

            try {
                // 1. حفظ جلسة الدخول في Firebase
                await setPersistence(auth, persistence); 
                
                // 2. حفظ/إزالة البريد الإلكتروني في التخزين المحلي (Local Storage)
                if (rememberMe) {
                    localStorage.setItem(REMEMBER_ME_KEY, email);
                } else {
                    localStorage.removeItem(REMEMBER_ME_KEY);
                }

                // 3. محاولة تسجيل الدخول
                const userCredential = await signInWithEmailAndPassword(auth, email, pass);
                await setDoc(doc(db, 'users', userCredential.user.uid), { lastLogin: Timestamp.now() }, { merge: true });
                await smartRedirect(userCredential.user);

            } catch (err) {
                console.error(err);
                showMsg("خطأ في الدخول: تأكد من البريد الإلكتروني أو كلمة المرور.", "error");
                btn.disabled = false;
                loader.classList.add('hidden');
            }
        };

        // --- Register Handler ---
        regForm.onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-register');
            const loader = btn.querySelector('.loader');
            
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            
            const selectVal = document.getElementById('reg-spec').value;
            const otherVal = document.getElementById('reg-spec-other').value;
            const finalSpec = (selectVal === 'other') ? otherVal : selectVal;

            if (!finalSpec) {
                showMsg("يرجى تحديد التخصص", "error");
                btn.disabled = false;
                loader.classList.add('hidden');
                return;
            }

            btn.disabled = true;
            loader.classList.remove('hidden');

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                const user = userCredential.user;

                await updateProfile(user, { displayName: name });

                await setDoc(doc(db, 'users', user.uid), {
                    uid: user.uid,
                    displayName: name,
                    email: email,
                    phone: phone,
                    specialization: finalSpec,
                    registrationDate: Timestamp.now(),
                    role: 'student'
                });

                // ملاحظة: التسجيل لا يحتاج لـ setPersistence، الافتراضي هو الجلسة المستمرة (Local)

                showMsg("تم إنشاء الحساب بنجاح! جاري الدخول...", "success");
                await smartRedirect(user);

            } catch (err) {
                console.error(err);
                let msg = "حدث خطأ أثناء التسجيل";
                if (err.code === 'auth/email-already-in-use') msg = "البريد الإلكتروني مستخدم بالفعل";
                if (err.code === 'auth/weak-password') msg = "كلمة المرور ضعيفة";
                showMsg(msg, "error");
                btn.disabled = false;
                loader.classList.add('hidden');
            }
        };

        // --- Forgot Password ---
        document.getElementById('forgot-pass').onclick = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            
            if(!email) {
                return showMsg("يرجى كتابة البريد الإلكتروني أولاً في حقل الدخول.", "error");
            }
            
            showMsg("جاري إرسال رابط إعادة تعيين كلمة المرور...", "success");

            try {
                await sendPasswordResetEmail(auth, email);
                
                // رسالة واضحة تحتوي على تنبيه SPAM
                showMsg("✅ تم الإرسال بنجاح! **تحقق من بريدك الإلكتروني (بما في ذلك مجلد رسائل المهملات/SPAM)** للحصول على رابط إعادة التعيين.", "success");
                
            } catch(err) {
                console.error(err);
                showMsg("⚠️ حدث خطأ: لم يتم العثور على هذا البريد الإلكتروني في نظامنا أو فشل الإرسال.", "error");
            }
        };
    </script>
</body>
</html>