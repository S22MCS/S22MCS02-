<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1200, initial-scale=1.0, user-scalable=yes">
    <title>Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø·Ø¨ - Ù…Ù‚Ø¯Ù… Ù…Ù† Ø£Ø¯Ø§Ø© Ø¹Ù„Ù…</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #0056b3;
            --primary-color-dark: #00408f;
            --secondary-color: #28a745;
            --secondary-color-dark: #218838;
            --danger-color: #dc3545;
            --danger-color-dark: #c82333;
            --neutral-color: #6c757d;
            --neutral-color-dark: #5a6268;
            --light-gray: #f7f9fc;
            --medium-gray: #e0e0e0;
            --dark-gray: #333;
            --white: #ffffff;
            --border-radius: 10px;
            --input-padding: 12px;
            --font-family: 'Tajawal', 'Arial', sans-serif;
            --table-header-bg: #007bff;
            --table-border-color: #dee2e6;
            --above-ten-bg: #d4edda;
            --above-ten-color: #155724;
            --below-ten-bg: #f8d7da;
            --below-ten-color: #721c24;
        }

        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 10px;
            background-color: var(--light-gray);
            direction: rtl;
            line-height: 1.6;
            color: var(--dark-gray);
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
        }

        .container {
            background-color: var(--white);
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: 0px 8px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 1000px;
            margin: 10px auto;
            transform: scale(1);
            transform-origin: top center;
        }

        h2 {
            color: var(--primary-color);
            font-size: 24px;
            margin-bottom: 20px;
            font-weight: 700;
            text-align: center;
        }

        h3 {
            color: var(--dark-gray);
            font-size: 20px;
            margin-top: 25px;
            margin-bottom: 15px;
            font-weight: 700;
            padding-bottom: 5px;
            text-align: right;
            border-bottom: 2px solid var(--medium-gray);
        }

        .input-table-container {
            width: 100%;
            overflow-x: auto;
            margin-bottom: 20px;
            -webkit-overflow-scrolling: touch;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
        }

        .grades-input-table {
            width: 100%;
            min-width: 700px;
            border-collapse: collapse;
            margin: 0 auto;
            font-size: 16px;
        }

        .grades-input-table th,
        .grades-input-table td {
            border: 1px solid var(--table-border-color);
            padding: 12px;
            text-align: center;
            vertical-align: middle;
        }

        .grades-input-table th {
            background-color: var(--table-header-bg);
            color: var(--white);
            font-weight: 500;
            font-size: 16px;
        }

        .grades-input-table td[data-label="Ø§Ù„Ù…Ù‚ÙŠØ§Ø³"] {
            text-align: right;
            font-weight: 500;
            min-width: 180px;
        }

        .grades-input-table td[data-label="Ø§Ù„Ù…Ø¹Ø§Ù…Ù„"],
        .grades-input-table td[data-label="Ø¥Ø¯Ø±Ø§Ø¬ TPØŸ"] {
            min-width: 80px;
        }

        .grades-input-table td[data-label="Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù…Ù‚ÙŠØ§Ø³"],
        .grades-input-table td[data-label="ÙŠÙ†Ù‚ØµÙƒ Ù„Ù„Ù…Ù‚ÙŠØ§Ø³"] {
            min-width: 100px;
            font-weight: bold;
        }

        .grades-input-table input[type="number"] {
            width: 100%;
            max-width: 90px;
            padding: 10px;
            border: 1px solid var(--medium-gray);
            border-radius: 6px;
            font-size: 16px;
            text-align: center;
            font-family: var(--font-family);
            height: 45px;
        }

        .grades-input-table input[type="number"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 86, 179, 0.2);
            outline: none;
        }

        .grades-input-table input[type="checkbox"] {
            width: 25px;
            height: 25px;
            cursor: pointer;
        }

        .calculated-avg-cell.above-ten {
            background-color: var(--above-ten-bg);
            color: var(--above-ten-color);
        }

        .calculated-avg-cell.below-ten {
            background-color: var(--below-ten-bg);
            color: var(--below-ten-color);
        }

        .positive {
            color: var(--secondary-color);
            font-weight: bold;
        }

        .negative {
            color: var(--danger-color);
            font-weight: bold;
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„ØµØºÙŠØ±Ø© */
        @media (max-width: 768px) {
            body {
                padding: 8px;
                font-size: 15px;
            }

            .container {
                padding: 12px;
            }

            h2 {
                font-size: 22px;
                margin-bottom: 15px;
            }

            h3 {
                font-size: 18px;
                margin-top: 20px;
                margin-bottom: 12px;
            }

            .grades-input-table th,
            .grades-input-table td {
                padding: 10px;
                font-size: 15px;
            }

            .grades-input-table input[type="number"] {
                padding: 8px;
                font-size: 15px;
                height: 40px;
            }

            .grades-input-table input[type="checkbox"] {
                width: 22px;
                height: 22px;
            }
        }

        @media (max-width: 480px) {
            body {
                font-size: 14px;
                padding: 5px;
            }

            .container {
                padding: 10px;
            }

            h2 {
                font-size: 20px;
            }

            h3 {
                font-size: 17px;
            }

            .grades-input-table thead {
                display: none;
            }

            .grades-input-table,
            .grades-input-table tbody,
            .grades-input-table tr,
            .grades-input-table td {
                display: block;
                width: 100%;
            }

            .grades-input-table tr {
                margin-bottom: 15px;
                border: 1px solid var(--table-border-color);
                border-radius: var(--border-radius);
                overflow: hidden;
            }

            .grades-input-table td {
                text-align: left;
                padding-left: 50%;
                position: relative;
                border: none;
                border-bottom: 1px solid var(--medium-gray);
                min-width: auto !important;
            }

            .grades-input-table td:last-child {
                border-bottom: none;
            }

            .grades-input-table td:before {
                content: attr(data-label);
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                width: 45%;
                padding-left: 10px;
                font-weight: bold;
                text-align: right;
                white-space: nowrap;
                font-size: 14px;
                color: var(--primary-color);
            }

            .grades-input-table input[type="number"] {
                max-width: 100%;
                font-size: 15px;
                height: 38px;
            }

            .grades-input-table td[data-label="Ø§Ù„Ù…Ù‚ÙŠØ§Ø³"] {
                padding: 15px;
                text-align: right;
                font-size: 16px;
                background-color: #f8f9fa;
                font-weight: bold;
            }

            .grades-input-table td[data-label="Ø§Ù„Ù…Ù‚ÙŠØ§Ø³"]:before {
                display: none;
            }

            .grades-input-table td[data-label="Ø¥Ø¯Ø±Ø§Ø¬ TPØŸ"] input[type="checkbox"] {
                float: left;
                margin-top: -3px;
            }
        }

        @media screen and (max-width: 1200px) {
            body {
                zoom: 0.8;
                overflow-x: auto;
            }
            .container {
                min-width: 1000px;
            }
        }

        .main-actions-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .main-actions-group button {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            font-family: var(--font-family);
        }

        .main-actions-group button:active {
            transform: scale(0.98);
        }

        .main-actions-group button#calculateButton {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .main-actions-group button#calculateButton:hover {
            background-color: var(--primary-color-dark);
        }

        .main-actions-group button#clearAllButton {
            background-color: var(--neutral-color);
            color: var(--white);
        }

        .main-actions-group button#clearAllButton:hover {
            background-color: var(--neutral-color-dark);
        }

        button.full-width-button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            font-family: var(--font-family);
            margin-top: 20px;
            margin-bottom: 20px;
        }

        button.full-width-button:active {
            transform: scale(0.98);
        }

        .capture-button {
            background-color: var(--secondary-color);
            color: var(--white);
        }

        .capture-button:hover {
            background-color: var(--secondary-color-dark);
        }

        .back-button-container {
            margin-top: 20px;
            text-align: center;
        }

        .back-button {
            display: inline-block;
            width: auto;
            padding: 12px 30px;
            background-color: var(--neutral-color);
            color: var(--white);
            font-size: 16px;
            transition: background-color 0.3s ease;
            border: none;
            border-radius: var(--border-radius);
            font-family: var(--font-family);
            cursor: pointer;
        }

        .back-button:hover {
            background-color: var(--neutral-color-dark);
        }

        .result-container {
            margin-top: 25px;
            padding: 20px;
            background-color: #f0f5ff;
            border-radius: var(--border-radius);
            box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.08);
            text-align: right;
        }

        .result-container h3.result-title {
            font-size: 20px;
            color: var(--dark-gray);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: none;
        }

        .result-container p {
            font-size: 17px;
            color: var(--dark-gray);
            margin: 10px 0;
            line-height: 1.7;
        }

        .result-container .unit-result-detail {
            font-size: 16px;
            padding-right: 10px;
            margin-bottom: 8px;
        }

        .final-grade-emphasis {
            font-weight: bold;
            font-size: 1.3em;
            color: var(--primary-color);
        }

        .motivational-message {
            font-size: 18px;
            font-weight: bold;
            margin-top: 20px;
            padding: 15px;
            border-radius: var(--border-radius);
        }

        .results-summary-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            font-size: 16px;
        }

        .results-summary-table th,
        .results-summary-table td {
            border: 1px solid var(--medium-gray);
            padding: 10px;
            text-align: right;
        }

        .results-summary-table th {
            background-color: #e9ecef;
            font-weight: bold;
        }

        .results-summary-table td.highlight {
            font-weight: bold;
            color: var(--primary-color);
        }

        @media (max-width: 600px) {
            .main-actions-group {
                flex-direction: column;
            }

            .main-actions-group button {
                width: 100%;
                margin-bottom: 10px;
            }

            .main-actions-group button:last-child {
                margin-bottom: 0;
            }

            .results-summary-table {
                font-size: 14px;
            }

            .results-summary-table th,
            .results-summary-table td {
                padding: 8px;
            }

            .result-container p {
                font-size: 15px;
            }

            .motivational-message {
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .results-summary-table {
                font-size: 13px;
            }

            .results-summary-table th,
            .results-summary-table td {
                padding: 6px;
            }

            .result-container h3.result-title {
                font-size: 18px;
            }

            .result-container .unit-result-detail {
                font-size: 15px;
            }

            .motivational-message {
                font-size: 15px;
                padding: 12px;
            }

            button.full-width-button,
            .main-actions-group button {
                font-size: 16px;
                padding: 14px;
            }

            .back-button {
                padding: 10px 25px;
                font-size: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="captureArea">
        <h2>Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø·Ø¨ - Ù…Ù‚Ø¯Ù… Ù…Ù† Ø£Ø¯Ø§Ø© Ø¹Ù„Ù…</h2>

        <h3>Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</h3>
        <div class="input-table-container">
            <table class="grades-input-table" id="first-year-modules-table">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ù…Ù‚ÙŠØ§Ø³</th>
                        <th>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„</th>
                        <th>Ø§Ù…ØªØ­Ø§Ù† 1</th>
                        <th>Ø§Ù…ØªØ­Ø§Ù† 2 (Ø¥Ù† ÙˆØ¬Ø¯)</th>
                        <th>Ø¹Ù„Ø§Ù…Ø© TP</th>
                        <th>Ø¥Ø¯Ø±Ø§Ø¬ TPØŸ</th>
                        <th>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù…Ù‚ÙŠØ§Ø³</th>
                        <th>ÙŠÙ†Ù‚ØµÙƒ Ù„Ù„Ù…Ù‚ÙŠØ§Ø³</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div class="main-actions-group">
            <button id="calculateButton" onclick="calculateAllResults()">Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø³Ù†ÙˆÙŠ</button>
            <button id="clearAllButton" onclick="clearAllInputs()">Ù…Ø­Ùˆ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø§Ù†Ø§Øª</button>
        </div>

        <div class="result-container" id="result-container" style="display: none;">
            <h3 class="result-title">ØªÙØ§ØµÙŠÙ„ Ù…Ø¹Ø¯Ù„Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³:</h3>
            <div id="modules_results_details"></div>
            
            <h3 class="result-title" style="margin-top:20px;">Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø³Ù†ÙˆÙŠ:</h3>
            <table class="results-summary-table" id="annual_summary_table">
                <thead><tr><th>Ø§Ù„Ù…Ù‚ÙŠØ§Ø³</th><th>Ø§Ù„Ù…Ø¹Ø¯Ù„</th><th>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ (Ø§Ù„Ù…Ø¹Ø¯Ù„ Ã— Ø§Ù„Ù…Ø¹Ø§Ù…Ù„)</th></tr></thead>
                <tbody></tbody>
                <tfoot></tbody>
            </table>
            <p style="margin-top: 20px;"><strong>Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø³Ù†ÙˆÙŠ Ø§Ù„ÙƒÙ„ÙŠ: <span id="total_annual_grade" class="final-grade-emphasis">--</span></strong></p>
            <p id="missing_points_to_10_container" style="display:none;">Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ 10 ÙÙŠ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø³Ù†ÙˆÙŠ: <span id="missing_points_to_10" class="negative">--</span></p>
            <div id="motivational_message" class="motivational-message" style="display:none;"></div>
        </div>

        <button class="capture-button full-width-button" onclick="captureScreen()">Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ù„Ù„Ù†ØªØ§Ø¦Ø¬</button>
        <div class="back-button-container">
             <button class="back-button" onclick="window.location.href='MED_CHOICE_PAGE.html';">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ù†Ø©</button>
        </div>
    </div>

    <script>
        const firstYearModules = [
            { id: "anatomie", name: "Anatomie (ØªØ´Ø±ÙŠØ­)", name_short: "Anatomie", coef: 2, singleExam: false },
            { id: "biophysique", name: "Biophysique (ÙÙŠØ²ÙŠØ§Ø¡ Ø­ÙŠÙˆÙŠØ©)", name_short: "Biophysique", coef: 2, singleExam: false },
            { id: "biochimie", name: "Biochimie (ÙƒÙŠÙ…ÙŠØ§Ø¡ Ø­ÙŠÙˆÙŠØ©)", name_short: "Biochimie", coef: 2, singleExam: false },
            { id: "biostat", name: "Biostat/Informatique (Ø¥Ø­ØµØ§Ø¡ Ø­ÙŠÙˆÙŠ/Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙŠØ©)", name_short: "Biostat/Info", coef: 2, singleExam: false },
            { id: "chimie", name: "Chimie (ÙƒÙŠÙ…ÙŠØ§Ø¡)", name_short: "Chimie", coef: 2, singleExam: false },
            { id: "cytologie", name: "Cytologie (Ø¹Ù„Ù… Ø§Ù„Ø®Ù„ÙŠØ©)", name_short: "Cytologie", coef: 2, singleExam: false },
            { id: "embryologie", name: "Embryologie (Ø¹Ù„Ù… Ø§Ù„Ø£Ø¬Ù†Ø©)", name_short: "Embryologie", coef: 1, singleExam: true },
            { id: "histologie", name: "Histologie (Ø¹Ù„Ù… Ø§Ù„Ø£Ù†Ø³Ø¬Ø©)", name_short: "Histologie", coef: 1, singleExam: true },
            { id: "physiologie", name: "Physiologie (ÙÙŠØ²ÙŠÙˆÙ„ÙˆØ¬ÙŠØ§)", name_short: "Physiologie", coef: 1, singleExam: true },
            { id: "ssh", name: "SSH (Ø¹Ù„ÙˆÙ… Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© ÙˆØ¥Ù†Ø³Ø§Ù†ÙŠØ©)", name_short: "SSH", coef: 1, singleExam: true }
        ];

        function generateInputTables() {
            const modulesTbody = document.getElementById('first-year-modules-table').getElementsByTagName('tbody')[0];
            modulesTbody.innerHTML = ''; 

            firstYearModules.forEach(mod => {
                const exam2InputHtml = mod.singleExam
                    ? `<td data-label="Ø§Ù…ØªØ­Ø§Ù† 2">-</td>`
                    : `<td data-label="Ø§Ù…ØªØ­Ø§Ù† 2"><input type="number" id="${mod.id}_exam2" class="grade-input exam2" min="0" max="20" step="0.01" placeholder="0-20" inputmode="decimal"></td>`;

                modulesTbody.innerHTML += `
                    <tr>
                        <td data-label="Ø§Ù„Ù…Ù‚ÙŠØ§Ø³">${mod.name}</td>
                        <td data-label="Ø§Ù„Ù…Ø¹Ø§Ù…Ù„">${mod.coef}</td>
                        <td data-label="Ø§Ù…ØªØ­Ø§Ù† 1"><input type="number" id="${mod.id}_exam1" class="grade-input exam1" min="0" max="20" step="0.01" placeholder="0-20" inputmode="decimal"></td>
                        ${exam2InputHtml}
                        <td data-label="Ø¹Ù„Ø§Ù…Ø© TP"><input type="number" id="${mod.id}_tp" class="grade-input tp" min="0" max="20" step="0.01" placeholder="0-20" inputmode="decimal"></td>
                        <td data-label="Ø¥Ø¯Ø±Ø§Ø¬ TPØŸ"><input type="checkbox" id="${mod.id}_include_tp" class="grade-input include_tp" checked></td>
                        <td data-label="Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù…Ù‚ÙŠØ§Ø³" id="${mod.id}_module_avg_display" class="calculated-avg-cell">--</td>
                        <td data-label="ÙŠÙ†Ù‚ØµÙƒ Ù„Ù„Ù…Ù‚ÙŠØ§Ø³" id="${mod.id}_module_missing_display">--</td>
                    </tr>`;
            });

            document.querySelectorAll('.grade-input').forEach(input => {
                const eventType = input.type === 'checkbox' ? 'change' : 'input';
                input.addEventListener(eventType, function() {
                    saveSpecificInput(this.id, this.type === 'checkbox' ? this.checked : this.value);
                    const moduleId = this.id.split('_')[0]; 
                    if (firstYearModules.some(m => m.id === moduleId)) {
                         updateModuleAverage(moduleId);
                    }
                });
                
                if (input.type === 'number') {
                    input.addEventListener('blur', function() {
                        let value = parseFloat(this.value);
                        if (isNaN(value) || value < 0) {
                            this.value = '';
                        } else if (value > 20) {
                            this.value = '20';
                        }
                         saveSpecificInput(this.id, this.value);
                         const moduleId = this.id.split('_')[0];
                         if (firstYearModules.some(m => m.id === moduleId)) {
                            updateModuleAverage(moduleId);
                         }
                    });
                }
            });
        }

        function saveSpecificInput(id, value) {
            if (typeof value === 'string' && value.trim() === '') {
                localStorage.removeItem(id);
            } else {
                localStorage.setItem(id, value);
            }
        }
        
        function getInputValue(id) {
            const inputElement = document.getElementById(id);
            if (!inputElement) return 0;

            if (inputElement.type === 'checkbox') {
                return inputElement.checked;
            }

            if (inputElement.value.trim() === '') return 0;
            let value = parseFloat(inputElement.value);
            return isNaN(value) ? 0 : value;
        }

        function updateModuleAverage(moduleId) {
            const mod = firstYearModules.find(m => m.id === moduleId);
            if (!mod) return;

            let exam1 = getInputValue(`${mod.id}_exam1`);
            let exam2 = mod.singleExam ? exam1 : getInputValue(`${mod.id}_exam2`);
            let tp = getInputValue(`${mod.id}_tp`);
            const includeTp = getInputValue(`${mod.id}_include_tp`);

            exam1 = Math.min(20, Math.max(0, exam1));
            if (!mod.singleExam) exam2 = Math.min(20, Math.max(0, exam2));
            tp = Math.min(20, Math.max(0, tp));

            let examsAverage = mod.singleExam ? exam1 : ((exam1 + exam2) / 2);
            let moduleAverage = includeTp ? (examsAverage + tp) / 2 : examsAverage;
            moduleAverage = Math.min(20, Math.max(0, moduleAverage));

            const avgDisplayCell = document.getElementById(`${mod.id}_module_avg_display`);
            const missingDisplayCell = document.getElementById(`${mod.id}_module_missing_display`);

            if (avgDisplayCell) {
                avgDisplayCell.textContent = moduleAverage.toFixed(2);
                avgDisplayCell.classList.remove('above-ten', 'below-ten');
                avgDisplayCell.classList.add(moduleAverage >= 10 ? 'above-ten' : 'below-ten');
            }

            if (missingDisplayCell) {
                const missingPoints = moduleAverage < 10 ? (10 - moduleAverage) : 0;
                missingDisplayCell.textContent = missingPoints.toFixed(2);
                missingDisplayCell.className = 'calculated-avg-cell';
                if (moduleAverage < 10 && missingPoints > 0) {
                     missingDisplayCell.classList.add('negative');
                } else if (moduleAverage >= 10) {
                     missingDisplayCell.classList.add('positive');
                     missingDisplayCell.textContent = "âœ”";
                } else {
                     missingDisplayCell.textContent = "0.00";
                }
            }
        }
        
        function loadSavedData() {
            firstYearModules.forEach(mod => {
                document.querySelectorAll(`#${mod.id}_exam1, #${mod.id}_exam2, #${mod.id}_tp`).forEach(el => {
                    if(el && localStorage.getItem(el.id) !== null) {
                        el.value = localStorage.getItem(el.id);
                    }
                });

                const includeTpCheckbox = document.getElementById(`${mod.id}_include_tp`);
                if (includeTpCheckbox) {
                    if (localStorage.getItem(includeTpCheckbox.id) !== null) {
                        includeTpCheckbox.checked = localStorage.getItem(includeTpCheckbox.id) === 'true';
                    } else {
                        includeTpCheckbox.checked = true;
                    }
                }
                updateModuleAverage(mod.id);
            });
        }

        function calculateAllResults() {
            let totalWeightedSum = 0;
            const totalCoefficients = firstYearModules.reduce((sum, mod) => sum + mod.coef, 0);
            
            const summaryTableBody = document.getElementById('annual_summary_table').getElementsByTagName('tbody')[0];
            summaryTableBody.innerHTML = ''; 

            let modulesResultsDetailsHtml = '';

            firstYearModules.forEach(mod => {
                updateModuleAverage(mod.id); 

                let exam1 = getInputValue(`${mod.id}_exam1`);
                let exam2 = mod.singleExam ? exam1 : getInputValue(`${mod.id}_exam2`);
                let tp = getInputValue(`${mod.id}_tp`);
                const includeTp = getInputValue(`${mod.id}_include_tp`);

                exam1 = Math.min(20, Math.max(0, exam1));
                if (!mod.singleExam) exam2 = Math.min(20, Math.max(0, exam2));
                tp = Math.min(20, Math.max(0, tp));

                let examsAverage = mod.singleExam ? exam1 : ((exam1 + exam2) / 2);
                let moduleAverage = includeTp ? (examsAverage + tp) / 2 : examsAverage;
                moduleAverage = Math.min(20, Math.max(0, moduleAverage));

                const weightedScore = moduleAverage * mod.coef;
                totalWeightedSum += weightedScore;

                let status = moduleAverage < 10 ? `<span class="negative">(ÙŠÙ†Ù‚ØµÙƒ: ${(10 - moduleAverage).toFixed(2)})</span>` : `<span class="positive">(Ù†Ø§Ø¬Ø­ âœ”)</span>`;
                modulesResultsDetailsHtml += `<p class="unit-result-detail"><strong>${mod.name}:</strong> ${moduleAverage.toFixed(2)} ${status}</p>`;
                
                let row = summaryTableBody.insertRow();
                row.insertCell().textContent = mod.name_short;
                let avgCell = row.insertCell();
                avgCell.textContent = moduleAverage.toFixed(2);
                avgCell.className = moduleAverage >= 10 ? 'above-ten' : 'below-ten';
                row.insertCell().textContent = mod.coef;
                row.insertCell().textContent = weightedScore.toFixed(2);
            });

            document.getElementById('modules_results_details').innerHTML = modulesResultsDetailsHtml;

            const annualAverage = totalCoefficients > 0 ? totalWeightedSum / totalCoefficients : 0;
            const finalGradeSpan = document.getElementById('total_annual_grade');
            finalGradeSpan.textContent = annualAverage.toFixed(3);
            finalGradeSpan.className = 'final-grade-emphasis';
            if (annualAverage >= 10) {
                finalGradeSpan.classList.add('positive');
            } else {
                finalGradeSpan.classList.add('negative');
            }

            let tfoot = document.getElementById('annual_summary_table').tFoot;
            if (!tfoot) tfoot = document.getElementById('annual_summary_table').createTFoot();
            tfoot.innerHTML = ''; 
            let totalRow = tfoot.insertRow();
            let headerCell = totalRow.insertCell();
            headerCell.innerHTML = `<strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ / Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø³Ù†ÙˆÙŠ</strong>`;
            headerCell.colSpan = 1;

            let avgTotalCell = totalRow.insertCell();
            avgTotalCell.innerHTML = `<strong>${annualAverage.toFixed(3)}</strong>`;
            avgTotalCell.className = annualAverage >=10 ? 'positive' : 'negative';

            let cellCoeff = totalRow.insertCell();
            cellCoeff.innerHTML = `<strong>${totalCoefficients}</strong>`; cellCoeff.classList.add('highlight');
            let cellTotalWeighted = totalRow.insertCell();
            cellTotalWeighted.innerHTML = `<strong>${totalWeightedSum.toFixed(2)}</strong>`; cellTotalWeighted.classList.add('highlight');
            
            const missingPointsContainer = document.getElementById('missing_points_to_10_container');
            const missingPointsEl = document.getElementById('missing_points_to_10');
            const motivationalMessageEl = document.getElementById('motivational_message');

            if (annualAverage < 10) {
                missingPointsEl.textContent = (10 - annualAverage).toFixed(3);
                missingPointsContainer.style.display = 'block';
                motivationalMessageEl.innerHTML = "Ù„Ø§ ØªØ³ØªØ³Ù„Ù…! Ù„Ø¯ÙŠÙƒ Ø§Ù„Ù‚Ø¯Ø±Ø© Ø¹Ù„Ù‰ ØªØ­Ø³ÙŠÙ† Ù†ØªØ§Ø¦Ø¬Ùƒ. Ø±ÙƒØ² Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø· Ø¶Ø¹ÙÙƒ ÙˆØ§Ø¬ØªÙ‡Ø¯ Ø£ÙƒØ«Ø± ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©. ÙƒÙ„ Ù†Ù‚Ø·Ø© ØªÙ‚Ø±Ø¨Ùƒ Ù…Ù† Ù‡Ø¯ÙÙƒ! ğŸ’ª";
                motivationalMessageEl.style.color = "var(--danger-color)"; 
                motivationalMessageEl.style.backgroundColor = "var(--below-ten-bg)"; 
                motivationalMessageEl.style.border = "1px solid var(--danger-color)";
            } else {
                missingPointsContainer.style.display = 'none';
                motivationalMessageEl.innerHTML = `Ù…Ù…ØªØ§Ø²! Ù…Ø¹Ø¯Ù„Ùƒ ${annualAverage.toFixed(3)}. Ø£Ù†Øª Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø§Ù„ØµØ­ÙŠØ­. ÙˆØ§ØµÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¦Ø¹! ğŸ‰`;
                motivationalMessageEl.style.color = "var(--secondary-color)"; 
                motivationalMessageEl.style.backgroundColor = "var(--above-ten-bg)"; 
                motivationalMessageEl.style.border = "1px solid var(--secondary-color)";
            }
            motivationalMessageEl.style.display = 'block';
            document.getElementById('result-container').style.display = 'block';
            document.getElementById('result-container').scrollIntoView({ behavior: 'smooth' });
        }

        function clearAllInputs() {
            const inputs = document.querySelectorAll('.grade-input');
            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    input.checked = true;
                } else {
                    input.value = '';
                }
                localStorage.removeItem(input.id);
            });

            firstYearModules.forEach(mod => {
                updateModuleAverage(mod.id);
                const avgDisplayCell = document.getElementById(`${mod.id}_module_avg_display`);
                if (avgDisplayCell) {
                    avgDisplayCell.textContent = '--';
                    avgDisplayCell.classList.remove('above-ten', 'below-ten');
                }
                const missingDisplayCell = document.getElementById(`${mod.id}_module_missing_display`);
                if (missingDisplayCell) {
                    missingDisplayCell.textContent = '--';
                    missingDisplayCell.className = 'calculated-avg-cell';
                }
            });
            
            document.getElementById('result-container').style.display = 'none';
            document.getElementById('modules_results_details').innerHTML = '';
            document.getElementById('annual_summary_table').getElementsByTagName('tbody')[0].innerHTML = '';
            const summaryTableFoot = document.getElementById('annual_summary_table').tFoot;
            if (summaryTableFoot) summaryTableFoot.innerHTML = '';
            document.getElementById('total_annual_grade').textContent = '--';
            document.getElementById('missing_points_to_10_container').style.display = 'none';
            document.getElementById('motivational_message').style.display = 'none';
        }

        function captureScreen() {
            const captureArea = document.getElementById('captureArea');
            const resultContainer = document.getElementById('result-container');
            
            if (resultContainer.style.display === 'none') {
                alert("ÙŠØ±Ø¬Ù‰ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù‚Ø¨Ù„ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©.");
                return;
            }

            html2canvas(captureArea, { 
                scrollY: -window.scrollY, 
                windowWidth: captureArea.scrollWidth,
                windowHeight: captureArea.scrollHeight,
                useCORS: true, 
                logging: false,
                backgroundColor: getComputedStyle(document.body).backgroundColor 
            })
            .then(canvas => {
                let link = document.createElement('a');
                link.download = 'Ù†ØªØ§Ø¦Ø¬_Ù…Ø¹Ø¯Ù„_Ø§Ù„Ø³Ù†Ø©_Ø§Ù„Ø£ÙˆÙ„Ù‰_Ø·Ø¨.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                URL.revokeObjectURL(link.href); 
            }).catch(error => {
                console.error("html2canvas failed:", error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø´Ø§Ø´Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¸Ø§Ù‡Ø±Ø©.");
            });
        }

        // Ù…Ù†Ø¹ ØªÙƒØ¨ÙŠØ±/ØªØµØºÙŠØ± Ø§Ù„ØµÙØ­Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©
        document.addEventListener('gesturestart', function (e) {
            e.preventDefault();
        });

        // Ø¶Ø¨Ø· Ø­Ø¬Ù… Ø§Ù„Ø®Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø©
        function adjustBaseFontSize() {
            const screenWidth = window.innerWidth;
            const baseSize = Math.min(16, Math.max(12, screenWidth / 60));
            document.documentElement.style.fontSize = baseSize + 'px';
        }

        window.addEventListener('resize', adjustBaseFontSize);

        window.onload = function() {
            generateInputTables();
            loadSavedData();
            firstYearModules.forEach(mod => updateModuleAverage(mod.id));
            adjustBaseFontSize();
            
            // ØªØ¹Ø·ÙŠÙ„ ØªÙƒÙŠÙŠÙ Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„ ÙˆØ¥Ø¬Ø¨Ø§Ø± Ø¹Ø±Ø¶ Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                document.querySelector('meta[name="viewport"]').content = 'width=1200, initial-scale=1.0, user-scalable=yes';
                document.body.style.zoom = "0.8";
                document.body.style.overflowX = "auto";
            }
        };
    </script>
</body>
</html>