<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة تحكم الإشعارات المحسّنة</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #007bff; --success-color: #28a745; --danger-color: #dc3545;
      --secondary-color: #6c757d; --light-gray: #f8f9fa; --dark-gray: #343a40; --border-radius: 8px;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--light-gray); margin: 0; padding: 15px; text-align: right; line-height: 1.6; }
    .hidden { display: none !important; }
    .container { max-width: 800px; margin: 20px auto; background: #ffffff; padding: 20px 25px; border-radius: var(--border-radius); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .header-group { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 1rem;}
    h2 { color: var(--dark-gray); margin-top: 0; margin-bottom: 0;}
    .logout-btn { background-color: var(--danger-color); color: white; border: none; padding: 8px 15px; border-radius: var(--border-radius); cursor: pointer; font-size: 14px; transition: background-color 0.3s; }
    .logout-btn:hover { background-color: #c82333; }
    .input-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 25px; }
    input[type="text"], input[type="url"] { flex-grow: 1; min-width: 150px; padding: 12px; font-size: 16px; border: 1px solid #ccc; border-radius: var(--border-radius); transition: border-color 0.3s, box-shadow 0.3s; }
    input[type="text"]:focus, input[type="url"]:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); outline: none; }
    select, .add-btn { padding: 12px; font-size: 16px; border-radius: var(--border-radius); cursor: pointer; background-color: #e9ecef; border: 1px solid #ced4da; }
    .add-btn { background-color: var(--primary-color); color: white; border: none; transition: background-color 0.3s ease; }
    .add-btn:hover { background-color: #0056b3; }
    ul { list-style: none; padding: 0; margin: 0; }
    li { background: #fff; padding: 12px 15px; margin-bottom: 10px; border-radius: var(--border-radius); border-right: 5px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; gap: 15px; word-break: break-word; transition: background-color 0.2s, border-color 0.2s; }
    li:hover { background-color: #f1f1f1; border-right-color: var(--primary-color); }
    li .notif-text { font-size: 1.1em; font-weight: 500; flex-grow: 1; display: flex; align-items: center; gap: 10px; }
    .notif-icon { color: var(--secondary-color); }
    .notif-link-preview { font-size: 0.8em; color: var(--primary-color); font-weight: normal; }
    .action-buttons { display: flex; gap: 5px; flex-shrink: 0; }
    .delete-btn, .edit-btn { background-color: transparent; padding: 5px 10px; font-size: 20px; border: none; opacity: 0.6; transition: opacity 0.3s, transform 0.3s, color 0.3s; }
    .delete-btn { color: var(--danger-color); } .edit-btn { color: var(--primary-color); }
    .delete-btn:hover, .edit-btn:hover { opacity: 1; transform: scale(1.1); }
    .edit-container { width: 100%; display: flex; flex-direction: column; gap: 8px; }
    .edit-input { width: calc(100% - 16px); font-size: 1em; padding: 8px; border: 1px solid var(--primary-color); border-radius: var(--border-radius); }
    .save-btn, .cancel-btn { padding: 8px 12px; font-size: 14px; border: none; color: white; cursor: pointer; border-radius: var(--border-radius); }
    .save-btn { background-color: var(--success-color); } .cancel-btn { background-color: var(--secondary-color); }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fefefe; margin: 15% auto; padding: 25px 30px; border: 1px solid #888; width: 90%; max-width: 450px; border-radius: var(--border-radius); box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; position: relative; }
    .close-button { color: #aaa; float: left; font-size: 28px; font-weight: bold; cursor: pointer; }
    .modal-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
    .modal-buttons button { padding: 10px 20px; border: none; font-size: 16px; cursor: pointer; border-radius: var(--border-radius); }
    .modal-buttons .btn-danger { background-color: var(--danger-color); color: white; }
    .modal-buttons .btn-secondary { background-color: #6c757d; color: white; }
  </style>
</head>
<body>

  <div id="loader" style="text-align: center; padding-top: 50px; font-size: 1.2rem;">جاري التحقق من الهوية...</div>

  <div id="app-container" class="container hidden">
    <div class="header-group">
        <h2><i class="fas fa-tasks"></i> لوحة تحكم الإشعارات</h2>
        <button id="logoutButton" class="logout-btn"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</button>
    </div>
    
    <div class="input-group">
      <input id="notifInput" type="text" placeholder="✍️ أدخل الإشعار الجديد هنا...">
      <input id="notifLink" type="url" placeholder="🔗 أدخل الرابط (اختياري)...">
      <input id="notifIcon" type="text" placeholder="أيقونة (مثل: fas fa-bullhorn)" value="fas fa-bell">
      
      <select id="notifColor" title="اختر لون الإشعار">
        <option value="black">أسود (افتراضي)</option>
        <option value="red" style="color:red; font-weight:bold;">أحمر</option>
        <option value="green" style="color:green; font-weight:bold;">أخضر</option>
        <option value="blue" style="color:blue; font-weight:bold;">أزرق</option>
      </select>
      
      <button id="addButton" class="add-btn">➕ إضافة</button>
    </div>
    
    <ul id="notifList">
      <li>جاري التحميل...</li>
    </ul>
  </div>

  <div id="deleteModal" class="modal">
    </div>

  <script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAJK6IUSw2YbwNVfB_hRNsOFeO08LEp4c8",
      authDomain: "adatealm-nofication.firebaseapp.com",
      projectId: "adatealm-nofication",
      storageBucket: "adatealm-nofication.appspot.com",
      messagingSenderId: "216068965336",
      appId: "1:216068965336:web:310c95e8e9fc4561cbe8ad",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const notificationsCollection = collection(db, "notifications");
    const loginUrl = "login_TAWASLE.html";

    // --- Auth Guard ---
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // المستخدم مسجل دخوله، أظهر التطبيق
        document.getElementById('loader').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
        initializeAppLogic();
      } else {
        // المستخدم ليس مسجلاً دخوله، أعده لصفحة الدخول
        window.location.replace(loginUrl);
      }
    });

    function initializeAppLogic() {
        // All the previous JavaScript logic for adding, deleting, editing notifications goes here
        // This ensures it only runs AFTER authentication is confirmed.
        
        let docToDeleteId = null;

        function showDeleteModal(docId, text) { /* ... same as original ... */ }
        function hideDeleteModal() { /* ... same as original ... */ }
        function toggleEditMode(li, docId, currentData) { /* ... same as original ... */ }
        function listenForNotifications() { /* ... same as original ... */ }
        async function addNotification() { /* ... same as original ... */ }

        // --- Event Listeners ---
        listenForNotifications();
        
        document.getElementById('addButton').onclick = addNotification;
        document.getElementById('logoutButton').onclick = () => {
          signOut(auth).catch((error) => console.error('Logout Error', error));
        };
        
        // ... rest of the event listeners ...
    }
    // Note: The actual function bodies for showDeleteModal, etc., are omitted for brevity
    // but they should be copied from the original file into the initializeAppLogic function.
  </script>
</body>
</html>