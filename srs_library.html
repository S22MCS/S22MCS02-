<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ù…ÙƒØªØ¨Ø© - Ø§Ù„Ø°Ø§ÙƒØ±Ø© PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { fontFamily: { sans: ['Tajawal', 'sans-serif'] }, colors: { brand: { DEFAULT: '#2563eb', dark: '#1d4ed8' }, dark: { bg: '#0f172a', card: '#1e293b', sidebar: '#111827' } }, padding: { 'safe': 'env(safe-area-inset-bottom)' } } } }
    </script>
</head>
<body class="bg-slate-50 dark:bg-dark-bg text-slate-800 font-sans transition-colors duration-300 pb-24 md:pb-0">

    <aside class="hidden md:flex fixed top-0 right-0 h-full w-64 bg-white dark:bg-dark-sidebar border-l border-gray-200 dark:border-gray-700 z-50 flex-col p-6 shadow-xl">
        <div class="flex items-center gap-3 mb-10">
            <div class="w-10 h-10 bg-brand rounded-xl flex items-center justify-center text-white shadow-lg shadow-brand/40"><i class="fas fa-brain text-xl"></i></div>
            <h1 class="font-black text-xl dark:text-white">Ø§Ù„Ø°Ø§ÙƒØ±Ø© <span class="text-brand">PRO</span></h1>
        </div>
        <nav class="space-y-2 flex-1">
            <a href="srs_index.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-500 hover:bg-gray-50 dark:hover:bg-slate-800 transition"><i class="fas fa-home w-6"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</a>
            <a href="srs_library.html" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-brand/10 text-brand font-bold transition"><i class="fas fa-layer-group w-6"></i> Ø§Ù„Ù…ÙƒØªØ¨Ø©</a>
        </nav>
    </aside>

    <main class="md:mr-64 min-h-screen p-4 md:p-8">
        <header class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="text-3xl font-black text-slate-800 dark:text-white mb-2">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…Ù†Ø§Ù‡Ø¬ ğŸ“š</h1>
                <p class="text-gray-500 dark:text-gray-400 text-sm">Ø§Ù„Ù…Ù†Ø§Ù‡Ø¬ Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ (ØªÙ… Ù†Ø´Ø±Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„).</p>
            </div>
            
            <button onclick="manualRefresh()" class="group flex items-center gap-2 bg-white dark:bg-dark-card border border-gray-200 dark:border-gray-700 px-4 py-2.5 rounded-xl hover:shadow-md transition active:scale-95 text-sm font-bold text-gray-600 dark:text-gray-300">
                <i id="refreshIcon" class="fas fa-sync-alt text-brand transition-transform duration-700"></i>
                <span>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙƒØªØ¨Ø©</span>
            </button>
        </header>

        <div id="libraryContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>
    </main>

    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-dark-card border-t border-gray-200 dark:border-gray-700 pb-safe z-50 flex justify-around items-center h-16 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
        <a href="srs_index.html" class="flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-brand dark:hover:text-blue-400 transition"><i class="fas fa-home text-xl mb-1"></i><span class="text-[10px] font-bold">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></a>
        <a href="srs_library.html" class="flex flex-col items-center justify-center w-full h-full text-brand dark:text-blue-400 transition"><i class="fas fa-layer-group text-xl mb-1"></i><span class="text-[10px] font-bold">Ø§Ù„Ù…ÙƒØªØ¨Ø©</span></a>
    </nav>

    <script>
        const REPO_KEY = 'srs_repo_content_live_v1';
        const DB_KEY = 'srs_pro_db_v1';
        const SETTINGS_KEY = 'srs_pro_settings_v1';
        
        let repoData = [];

        function init() {
            const s = localStorage.getItem(SETTINGS_KEY);
            if(s && JSON.parse(s).darkMode) document.documentElement.classList.add('dark');
            loadData();
        }

        // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¹Ø±Ø¶Ù‡Ø§
        function loadData() {
            const storedRepo = localStorage.getItem(REPO_KEY);
            if (storedRepo) {
                repoData = JSON.parse(storedRepo);
                renderLibrary();
            } else {
                renderEmptyState();
            }
        }

        // 1. Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙŠØ¯ÙˆÙŠ
        function manualRefresh() {
            // ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
            const icon = document.getElementById('refreshIcon');
            icon.classList.add('rotate-[360deg]');
            setTimeout(() => icon.classList.remove('rotate-[360deg]'), 700);

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            loadData();

            // Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ ØµØºÙŠØ±Ø©
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
            Toast.fire({ icon: 'success', title: 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙƒØªØ¨Ø©' });
        }

        // 2. Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø£Ø­Ø¯Ø§Ø«)
        // Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¹Ù…Ù„ Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¨Ø§Ù„Ù†Ø´Ø± ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¢Ø®Ø±
        window.addEventListener('storage', function(e) {
            if (e.key === REPO_KEY) {
                console.log('Detected changes from Admin panel...');
                loadData(); // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
                
                // ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
                Toast.fire({ icon: 'info', title: 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ÙƒØªØ¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹' });
            }
        });

        function renderEmptyState() {
            document.getElementById('libraryContainer').innerHTML = `
                <div class="col-span-full flex flex-col items-center justify-center py-20 text-center text-gray-400">
                    <div class="bg-gray-100 dark:bg-slate-800 rounded-full w-24 h-24 flex items-center justify-center mb-4">
                        <i class="fas fa-folder-open text-4xl opacity-50"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2 dark:text-gray-300">Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙØ§Ø±ØºØ© Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
                    <p class="text-sm opacity-70">Ù„Ù… ÙŠÙ‚Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¨Ù†Ø´Ø± Ø£ÙŠ Ù…Ù†Ø§Ù‡Ø¬ Ø¨Ø¹Ø¯.</p>
                    <button onclick="manualRefresh()" class="mt-4 text-brand text-sm font-bold hover:underline">ØªØ­Ù‚Ù‚ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
                </div>
            `;
        }

        function renderLibrary() {
            const container = document.getElementById('libraryContainer');
            if (repoData.length === 0) { renderEmptyState(); return; }

            container.innerHTML = repoData.map(item => {
                let lessonCount = 0;
                let subjectCount = item.subjects.length;
                item.subjects.forEach(sub => lessonCount += sub.lessons.length);

                return `
                <div class="bg-white dark:bg-dark-card rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden hover:shadow-lg transition flex flex-col h-full group">
                    <div class="h-32 ${item.color} relative p-6 flex flex-col justify-between">
                        <div class="w-12 h-12 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-white text-2xl shadow-inner">
                            <i class="fas ${item.icon}"></i>
                        </div>
                        <h3 class="text-white font-black text-xl drop-shadow-md leading-tight">${item.title}</h3>
                    </div>
                    <div class="p-6 flex-1 flex flex-col">
                        <p class="text-gray-500 text-sm mb-4 flex-1 line-clamp-3">${item.desc}</p>
                        
                        <div class="flex items-center gap-4 text-xs font-bold text-gray-400 mb-6">
                            <span class="bg-gray-100 dark:bg-slate-800 px-3 py-1 rounded-full"><i class="fas fa-book ml-1"></i> ${subjectCount} Ù…ÙˆØ§Ø¯</span>
                            <span class="bg-gray-100 dark:bg-slate-800 px-3 py-1 rounded-full"><i class="fas fa-list-ul ml-1"></i> ${lessonCount} Ø¯Ø±Ø³</span>
                        </div>

                        <button onclick="importCourse(${item.id})" class="w-full py-3 bg-brand/10 text-brand font-bold rounded-xl hover:bg-brand hover:text-white transition active:scale-95 flex items-center justify-center gap-2">
                            <i class="fas fa-download"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù„Ù„Ù…ÙƒØªØ¨Ø©
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }

        function importCourse(id) {
            const course = repoData.find(c => c.id === id);
            if (!course) return;

            Swal.fire({
                title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯',
                text: `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ù‡Ø¬ "${course.title}" Ø¥Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ÙƒØŸ`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø£Ø¶Ù Ø§Ù„Ø¯Ø±ÙˆØ³',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                confirmButtonColor: '#2563eb'
            }).then((result) => {
                if (result.isConfirmed) {
                    let userDB = JSON.parse(localStorage.getItem(DB_KEY)) || { lessons: [], user: {} };
                    let addedCount = 0;
                    const now = new Date();
                    const next = new Date(); next.setDate(now.getDate() + 1);

                    course.subjects.forEach(sub => {
                        sub.lessons.forEach(lessonTitle => {
                            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ù„Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„Ø¯Ø±Ø³)
                            const exists = userDB.lessons.some(l => l.title === lessonTitle && l.subject === sub.name);
                            if (!exists) {
                                userDB.lessons.push({
                                    id: Date.now() + Math.random(),
                                    subject: sub.name,
                                    title: lessonTitle,
                                    layer: 0,
                                    nextReview: next.toISOString(),
                                    lastReview: now.toISOString(),
                                    easeFactor: 2.5
                                });
                                addedCount++;
                            }
                        });
                    });

                    if (addedCount > 0) {
                        localStorage.setItem(DB_KEY, JSON.stringify(userDB));
                        Swal.fire({ 
                            title: 'ØªÙ… Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰', 
                            text: `ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${addedCount} Ø¯Ø±Ø³Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹ Ø¥Ù„Ù‰ Ø¬Ø¯ÙˆÙ„Ùƒ.`, 
                            icon: 'success',
                            confirmButtonColor: '#2563eb'
                        });
                    } else {
                        Swal.fire({ 
                            title: 'Ù…Ù„Ø§Ø­Ø¸Ø©', 
                            text: 'Ø¬Ù…ÙŠØ¹ Ø¯Ø±ÙˆØ³ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ù‡Ø¬ Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø¬Ø¯ÙˆÙ„Ùƒ.', 
                            icon: 'info' 
                        });
                    }
                }
            });
        }

        init();
    </script>
</body>
</html>