<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø·Ø¨ÙŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary: #0fb9b1; --primary-dark: #20bf6b; --accent: #f7b731;
            --bg-body: #1e272e; --bg-app: #f1f2f6; --text: #2d3436;
            --slot-bg: #dfe6e9; --key-bg: #ffffff; --font: 'Cairo', sans-serif;
        }
        [data-theme="dark"] {
            --primary: #4bcffa; --primary-dark: #0fb9b1;
            --bg-body: #000000; --bg-app: #1e272e; --text: #f5f6fa;
            --slot-bg: #2f3640; --key-bg: #353b48;
        }
        * { box-sizing: border-box; font-family: var(--font); user-select: none; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; background: var(--bg-body); height: 100dvh; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        
        #app { width: 100%; height: 100%; max-width: 500px; background: var(--bg-app); display: flex; flex-direction: column; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.5); overflow: hidden; }
        .screen { display: none; flex-direction: column; height: 100%; padding: 20px; animation: fadeIn 0.3s ease; overflow-y: auto; position: relative; }
        .screen.active { display: flex; }
        .screen.center-content { justify-content: center; align-items: center; text-align: center; }
        @keyframes fadeIn { from {opacity:0; transform: scale(0.98);} to {opacity:1; transform: scale(1);} }

        /* UI Elements */
        .logo { font-size: clamp(2rem, 7vw, 3.5rem); color: var(--primary-dark); margin-bottom: 10px; font-weight: 900; }
        .main-btn { background: var(--primary); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 1.2rem; font-weight: bold; width: 90%; cursor: pointer; margin: 10px 0; transition: transform 0.2s; }
        .main-btn:active { transform: translateY(3px); }
        .top-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; margin-bottom: 10px; }
        .coin-badge { background: var(--accent); color: #2d3436; padding: 5px 15px; border-radius: 20px; font-weight: 800; font-size: 0.9rem; }
        
        /* Image Slider & Viewer */
        .images-container {
            width: 100%; max-height: 25vh; margin-bottom: 15px;
            display: flex; gap: 10px; overflow-x: auto; scroll-snap-type: x mandatory;
            padding-bottom: 5px; /* For scrollbar space */
        }
        .images-container::-webkit-scrollbar { height: 4px; }
        .images-container::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }
        
        .game-img-wrapper {
            flex: 0 0 auto; width: 100%; height: 100%; 
            background: var(--slot-bg); border-radius: 15px; 
            display: flex; justify-content: center; align-items: center; 
            overflow: hidden; scroll-snap-align: center; border: 1px solid rgba(0,0,0,0.1);
            position: relative;
        }
        .game-img { width: 100%; height: 100%; object-fit: contain; cursor: zoom-in; }
        .zoom-hint { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.5); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; pointer-events: none; }

        /* Questions */
        .question-box { text-align: center; margin-bottom: 20px; width: 100%; }
        .q-main { font-size: clamp(1.1rem, 5vw, 1.5rem); font-weight: 800; color: var(--text); }
        .q-sub { font-size: clamp(0.9rem, 4vw, 1.1rem); color: #636e72; direction: ltr; margin-top: 2px; }
        
        /* Game Area */
        .slots-area { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; margin-bottom: auto; padding-bottom: 20px; direction: rtl; }
        .slot { width: clamp(35px, 11vw, 50px); height: clamp(35px, 11vw, 50px); background: var(--slot-bg); border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: clamp(1.2rem, 5vw, 1.6rem); font-weight: 800; color: var(--text); cursor: pointer; border-bottom: 3px solid rgba(0,0,0,0.1); }
        .slot.filled { background: var(--primary); color: white; transform: scale(1.05); }
        .slot.hinted { background: #00cec9 !important; color: white; }
        
        .controls-area { width: 100%; position: relative; padding-top: 10px; }
        .hint-btn { position: absolute; top: -70px; left: 10px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(45deg, #fdcb6e, #e17055); border: none; color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 6px 15px rgba(225, 112, 85, 0.4); cursor: pointer; z-index: 5; }
        .keyboard { background: var(--key-bg); padding: 15px; border-radius: 25px 25px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); display: grid; grid-template-columns: repeat(auto-fit, minmax(40px, 1fr)); gap: 8px; }
        .key-btn { aspect-ratio: 1; background: var(--bg-app); border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; color: var(--text); box-shadow: 0 3px 0 rgba(0,0,0,0.1); }
        .key-btn.used { opacity: 0; pointer-events: none; }

        /* Loader */
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; display:none; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Lightbox (Professional Zoom) */
        #lightbox {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        #lightbox img {
            max-width: 100%; max-height: 80vh; object-fit: contain;
            transition: transform 0.2s ease-out; cursor: grab;
        }
        .lightbox-controls {
            position: absolute; bottom: 30px; display: flex; gap: 20px; z-index: 2001;
        }
        .zoom-btn {
            background: rgba(255,255,255,0.2); color: white; border: 1px solid white;
            width: 50px; height: 50px; border-radius: 50%; font-size: 1.5rem; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
        }
        .close-lightbox {
            position: absolute; top: 20px; right: 20px; background: none; border: none;
            color: white; font-size: 2rem; cursor: pointer; z-index: 2001;
        }

        /* Win Modal */
        .modal-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 50; backdrop-filter: blur(5px); }
        .win-card { background: white; width: 85%; max-width: 350px; border-radius: 20px; text-align: center; animation: popUp 0.4s; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .win-header { background: linear-gradient(135deg, #20bf6b, #0fb9b1); color: white; padding: 15px; }
        .win-body { padding: 20px; color: #2d3436; }
        .win-img { max-height: 120px; max-width: 100%; object-fit: contain; margin-bottom: 10px; }
        .win-answer { font-size: 2rem; font-weight: 900; color: #20bf6b; margin: 10px 0; }
        .action-btns { display: flex; gap: 10px; justify-content: center; padding: 15px; width: 100%; max-width: 350px; }
        .action-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; color: white; }
        .btn-save { background: #f7b731; color: #2d3436; } .btn-next { background: #20bf6b; }
        @keyframes popUp { from {transform:scale(0.5); opacity:0;} to {transform:scale(1); opacity:1;} }
    </style>
</head>
<body>

<div id="lightbox">
    <button class="close-lightbox" onclick="closeLightbox()">âœ•</button>
    <img id="lightbox-img" src="">
    <div class="lightbox-controls">
        <button class="zoom-btn" onclick="zoomOut()">âˆ’</button>
        <button class="zoom-btn" onclick="zoomIn()">+</button>
    </div>
</div>

<div id="app">
    <div id="screen-home" class="screen active center-content">
        <div class="logo">Ø£Ø¯Ø§Ø© Ø¹Ù„Ù…<br>Ø§Ù„Ø·Ø¨ÙŠØ©</div>
        <div class="loader" id="loader-home"></div>
        <p id="status-msg" style="color:var(--text); font-size:0.9rem;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©...</p>
        <button class="main-btn" onclick="startGame()" id="btn-start" style="display:none;">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ â–¶ï¸</button>
        <div style="margin-top:20px; color:var(--text);">Ù…Ø±Ø­Ù„Ø©: <span id="home-lvl">1</span></div>
    </div>

    <div id="screen-game" class="screen">
        <div class="top-header">
            <button onclick="location.reload()" style="background:none;border:none;font-size:1.5rem">ğŸ </button>
            <div style="font-weight:bold; color:var(--text)">Ù…Ø±Ø­Ù„Ø© <span id="game-lvl">1</span></div>
            <div class="coin-badge">ğŸ’ <span id="game-coins">0</span></div>
        </div>

        <div class="game-content">
            <div id="images-container" class="images-container" style="display:none;">
                </div>

            <div id="question-container" class="question-box"></div>
            <div id="slots-area" class="slots-area"></div>
        </div>

        <div class="controls-area">
            <button class="hint-btn" onclick="useHint()">
                <span style="font-size:1.4rem">ğŸ’¡</span>
                <span style="font-size:0.7rem; font-weight:bold">-30</span>
            </button>
            <div id="keyboard-area" class="keyboard"></div>
        </div>
    </div>

    <div id="screen-finish" class="screen center-content">
        <div style="font-size: 5rem;">ğŸ“</div>
        <h1 style="color:var(--primary);">Ù…Ø¨Ø±ÙˆÙƒ Ø§Ù„ØªØ®Ø±Ø¬!</h1>
        <p style="color:var(--text);">Ø£Ù†Ù‡ÙŠØª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©.</p>
        <button class="main-btn" onclick="resetProgress()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¯ÙˆØ±Ø© ğŸ”„</button>
    </div>

    <div id="modal-win" class="modal-overlay">
        <div style="display:flex; flex-direction:column; align-items:center;">
            <div id="win-card-content" class="win-card">
                <div class="win-header">
                    <div style="font-size:1.5rem; font-weight:bold;">Ù…Ø¹Ù„ÙˆÙ…Ø© Ø·Ø¨ÙŠØ©</div>
                </div>
                <div class="win-body">
                    <img id="win-img-display" class="win-img" src="" style="display:none">
                    <div class="q-main" id="win-q-text" style="font-size:1rem;color:#555"></div>
                    <div class="win-answer" id="win-a-text"></div>
                </div>
                <div style="background:#eee; padding:5px; font-size:0.8rem">Ø£Ø¯Ø§Ø© Ø¹Ù„Ù… - Ù‚Ø³Ù… Ø§Ù„Ø·Ø¨</div>
            </div>
            <div class="action-btns">
                <button class="action-btn btn-save" onclick="shareInfo()">ğŸ“¸ Ø­ÙØ¸</button>
                <button class="action-btn btn-next" onclick="nextLevel()">Ø§Ù„ØªØ§Ù„ÙŠ â¬…ï¸</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDAEbxYuAHu5stGx5c02VbgsUKBhoidTeA",
        authDomain: "informationpassmemberessystem.firebaseapp.com",
        databaseURL: "https://informationpassmemberessystem-default-rtdb.firebaseio.com",
        projectId: "informationpassmemberessystem",
        storageBucket: "informationpassmemberessystem.firebasestorage.app",
        messagingSenderId: "890696552799",
        appId: "1:890696552799:web:b0889cdfcd6e1e6b7466ea",
        measurementId: "G-RTB7F6BK3Y"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let levels = [];
    let progress = parseInt(localStorage.getItem('game_progress') || 0);
    let coins = parseInt(localStorage.getItem('game_coins') || 100);
    let currentAns = [];
    let targetAns = "";
    
    // Zoom Vars
    let currentZoom = 1;

    window.startGame = startGame;
    window.useHint = useHint;
    window.nextLevel = nextLevel;
    window.shareInfo = shareInfo;
    window.resetProgress = resetProgress;
    window.openLightbox = openLightbox;
    window.closeLightbox = closeLightbox;
    window.zoomIn = zoomIn;
    window.zoomOut = zoomOut;

    async function init() {
        updateUI();
        document.getElementById('loader-home').style.display = 'block';
        try {
            const snapshot = await get(ref(db, 'levels'));
            if (snapshot.exists()) {
                levels = snapshot.val();
                levels = levels.filter(el => el != null);
                document.getElementById('status-msg').innerText = `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${levels.length} Ù…Ø±Ø­Ù„Ø©`;
                document.getElementById('btn-start').style.display = 'block';
            } else {
                document.getElementById('status-msg').innerText = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§Ø­Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹";
            }
        } catch (error) {
            console.error(error);
            document.getElementById('status-msg').innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„!";
        }
        document.getElementById('loader-home').style.display = 'none';
    }

    function updateUI() {
        document.getElementById('home-lvl').innerText = progress + 1;
        document.getElementById('game-lvl').innerText = progress + 1;
        document.getElementById('game-coins').innerText = coins;
    }

    function startGame() {
        if (levels.length === 0) return;
        if (progress >= levels.length) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-finish').classList.add('active');
            return;
        }
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-game').classList.add('active');
        loadLevel(progress);
    }

    function loadLevel(idx) {
        const lvl = levels[idx];
        targetAns = lvl.a.trim();
        currentAns = new Array(targetAns.length).fill(null);

        // Render Question
        const qBox = document.getElementById('question-container');
        qBox.innerHTML = `<div class="q-main">${lvl.q}</div>`;
        if(lvl.q_en) qBox.innerHTML += `<div class="q-sub">ğŸ‡¬ğŸ‡§ ${lvl.q_en}</div>`;
        if(lvl.q_fr) qBox.innerHTML += `<div class="q-sub">ğŸ‡«ğŸ‡· ${lvl.q_fr}</div>`;

        // Render Images (Multiple)
        const imgContainer = document.getElementById('images-container');
        imgContainer.innerHTML = '';
        
        // Ø¯Ø¹Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… (img) ÙˆØ§Ù„Ø¬Ø¯ÙŠØ¯ (images array)
        let imgsToLoad = [];
        if(lvl.images && Array.isArray(lvl.images)) {
            imgsToLoad = lvl.images;
        } else if (lvl.img) {
            imgsToLoad = [lvl.img];
        }

        if(imgsToLoad.length > 0) {
            imgContainer.style.display = 'flex';
            imgsToLoad.forEach(src => {
                // Ø§Ù†Ø´Ø§Ø¡ Ø­Ø§ÙˆÙŠØ© Ù„ÙƒÙ„ ØµÙˆØ±Ø©
                const wrapper = document.createElement('div');
                wrapper.className = 'game-img-wrapper';
                
                const img = document.createElement('img');
                img.className = 'game-img';
                img.src = src;
                img.onclick = () => openLightbox(src); // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø§ÙØªØ­ Ø§Ù„Ø²ÙˆÙˆÙ…
                
                const hint = document.createElement('div');
                hint.className = 'zoom-hint';
                hint.innerText = 'ğŸ” Ø§Ø¶ØºØ· Ù„Ù„ØªÙƒØ¨ÙŠØ±';

                wrapper.appendChild(img);
                wrapper.appendChild(hint);
                imgContainer.appendChild(wrapper);
            });
        } else {
            imgContainer.style.display = 'none';
        }

        // Direction Logic
        const slotsArea = document.getElementById('slots-area');
        const isArabic = /[\u0600-\u06FF]/.test(targetAns);
        slotsArea.style.direction = isArabic ? 'rtl' : 'ltr';

        renderSlots();
        renderKeyboard(targetAns);
    }

    function renderSlots() {
        const box = document.getElementById('slots-area');
        box.innerHTML = '';
        currentAns.forEach((item, i) => {
            const el = document.createElement('div');
            el.className = `slot ${item ? 'filled' : ''}`;
            if(item && item.isHint) el.classList.add('hinted');
            el.innerText = item ? item.char : '';
            if(item) el.onclick = () => removeChar(i);
            box.appendChild(el);
        });
    }

    function renderKeyboard(ansStr) {
        const box = document.getElementById('keyboard-area');
        box.innerHTML = '';
        let chars = ansStr.split('').map((c, i) => ({c, id: i}));
        chars.sort(() => Math.random() - 0.5);

        chars.forEach(obj => {
            const btn = document.createElement('button');
            btn.className = 'key-btn';
            btn.innerText = obj.c;
            btn.onclick = () => { if(!btn.classList.contains('used')) addChar(obj, btn); }
            obj.btn = btn; 
            box.appendChild(btn);
        });
    }

    function addChar(obj, btn) {
        const emptyIdx = currentAns.indexOf(null);
        if(emptyIdx !== -1) {
            currentAns[emptyIdx] = { char: obj.c, btn: btn, isHint: false };
            btn.classList.add('used');
            renderSlots();
            checkWin();
        }
    }

    function removeChar(idx) {
        const item = currentAns[idx];
        if(item) {
            item.btn.classList.remove('used');
            currentAns[idx] = null;
            renderSlots();
        }
    }

    function checkWin() {
        if(!currentAns.includes(null)) {
            const txt = currentAns.map(x => x.char).join('');
            if(txt === targetAns) {
                setTimeout(showWinModal, 300);
            } else {
                document.getElementById('slots-area').animate([
                    {transform: 'translateX(0)'}, {transform: 'translateX(5px)'}, {transform: 'translateX(-5px)'}, {transform: 'translateX(0)'}
                ], {duration: 300});
            }
        }
    }

    function showWinModal() {
        coins += 20;
        localStorage.setItem('game_coins', coins);
        updateUI();

        const lvl = levels[progress];
        document.getElementById('win-q-text').innerText = lvl.q;
        document.getElementById('win-a-text').innerText = lvl.a;
        
        const winImg = document.getElementById('win-img-display');
        // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙ‚Ø· ÙÙŠ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙÙˆØ²
        const imgToShow = (lvl.images && lvl.images[0]) || lvl.img;
        
        if(imgToShow) {
            winImg.src = imgToShow;
            winImg.style.display = 'block';
        } else {
            winImg.style.display = 'none';
        }
        
        document.getElementById('modal-win').style.display = 'flex';
    }

    function nextLevel() {
        document.getElementById('modal-win').style.display = 'none';
        progress++;
        localStorage.setItem('game_progress', progress);
        startGame();
    }

    function useHint() {
        if(coins < 30) { alert('ØªØ­ØªØ§Ø¬ 30 Ù…Ø§Ø³Ø© ğŸ’'); return; }
        const emptyIdx = currentAns.indexOf(null);
        if(emptyIdx === -1) { alert('Ø§Ø­Ø°Ù Ø­Ø±ÙØ§Ù‹ Ø®Ø§Ø·Ø¦Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹'); return; }

        const correctChar = targetAns[emptyIdx];
        const btns = Array.from(document.querySelectorAll('.key-btn:not(.used)'));
        const targetBtn = btns.find(b => b.innerText === correctChar);

        if(targetBtn) {
            coins -= 30;
            localStorage.setItem('game_coins', coins);
            updateUI();
            currentAns[emptyIdx] = { char: correctChar, btn: targetBtn, isHint: true };
            targetBtn.classList.add('used');
            renderSlots();
            checkWin();
        }
    }

    function shareInfo() {
        const card = document.getElementById('win-card-content');
        html2canvas(card, { scale: 2, backgroundColor: "#ffffff" }).then(canvas => {
            const link = document.createElement('a');
            link.download = `Medical_Info_${progress+1}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
        });
    }

    function resetProgress() {
        if(confirm("Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨ØŸ")) {
            progress = 0;
            localStorage.setItem('game_progress', 0);
            location.reload();
        }
    }

    /* --- Lightbox Logic --- */
    function openLightbox(src) {
        document.getElementById('lightbox-img').src = src;
        document.getElementById('lightbox').style.display = 'flex';
        currentZoom = 1;
        applyZoom();
    }
    
    function closeLightbox() {
        document.getElementById('lightbox').style.display = 'none';
    }

    function zoomIn() {
        currentZoom += 0.2;
        applyZoom();
    }

    function zoomOut() {
        if(currentZoom > 0.4) currentZoom -= 0.2;
        applyZoom();
    }

    function applyZoom() {
        document.getElementById('lightbox-img').style.transform = `scale(${currentZoom})`;
    }

    init();
</script>
</body>
</html>