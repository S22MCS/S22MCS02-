<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الملف الأكاديمي - الطالب</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f3f4f6; }
        .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .profile-card { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        select {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: left 0.5rem center; background-size: 1em;
        }
    </style>
</head>
<body>

    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-university text-indigo-600 text-2xl"></i>
                <h1 class="text-xl font-bold text-gray-800">بوابة الطالب</h1>
            </div>
            <button id="logout-btn" class="text-red-500 hover:bg-red-50 px-3 py-1 rounded-lg transition font-medium text-sm">
                تسجيل خروج <i class="fas fa-sign-out-alt mr-1"></i>
            </button>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8 max-w-5xl">

        <div id="page-loader" class="flex justify-center py-20">
            <div class="loader w-10 h-10" style="width:40px; height:40px;"></div>
        </div>

        <div id="main-content" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden relative">
                    <div class="h-32 profile-card relative"><div class="absolute inset-0 bg-pattern opacity-10"></div></div>
                    <div class="px-6 pb-6 relative">
                        <div class="relative -mt-16 mb-4 flex justify-center">
                            <div class="w-32 h-32 rounded-full border-4 border-white shadow-md overflow-hidden bg-gray-100 relative group">
                                <img id="profile-img" src="https://via.placeholder.com/150" class="w-full h-full object-cover">
                                <label for="img-upload" class="absolute inset-0 bg-black/50 flex items-center justify-center text-white opacity-0 group-hover:opacity-100 cursor-pointer transition duration-300">
                                    <i class="fas fa-camera text-2xl"></i>
                                </label>
                                <input type="file" id="img-upload" class="hidden" accept="image/*">
                            </div>
                            <div id="upload-loader" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 hidden"><div class="loader border-white"></div></div>
                        </div>

                        <div class="text-center">
                            <h2 id="user-name" class="text-xl font-bold text-gray-900 mb-1">جاري التحميل...</h2>
                            <p id="user-role" class="text-sm text-indigo-600 font-semibold bg-indigo-50 inline-block px-3 py-1 rounded-full mb-4">طالب جامعي</p>
                            
                            <div class="flex justify-center gap-4 text-sm text-gray-500 border-t pt-4">
                                <div class="text-center"><p class="font-bold text-gray-800" id="contrib-count">0</p><p>مساهمة</p></div>
                                <div class="w-px bg-gray-200"></div>
                                <div class="text-center"><p class="font-bold text-gray-800">نشط</p><p>الحالة</p></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <h3 class="font-bold text-gray-800 mb-4">روابط سريعة</h3>
                    <div class="space-y-3">
                        <a href="contribute.html" class="flex items-center gap-3 p-3 rounded-lg bg-gray-50 hover:bg-indigo-50 hover:text-indigo-600 transition text-gray-700">
                            <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600"><i class="fas fa-plus"></i></div>
                            <span class="font-medium">إضافة مساهمة جديدة</span>
                        </a>
                        <button class="w-full flex items-center gap-3 p-3 rounded-lg bg-gray-50 hover:bg-green-50 hover:text-green-600 transition text-gray-700 text-right">
                            <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-600"><i class="fas fa-chart-line"></i></div>
                            <span class="font-medium">سجل درجاتي (قريباً)</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white rounded-2xl shadow-sm p-8 border-r-4 border-indigo-500 relative group">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800"><i class="fas fa-graduation-cap text-indigo-500 ml-2"></i> البيانات الأكاديمية</h3>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded">تم التحقق</span>
                            <button id="edit-info-btn" class="text-indigo-600 bg-indigo-50 hover:bg-indigo-100 p-2 rounded-full transition shadow-sm" title="تعديل البيانات">
                                <i class="fas fa-pen text-sm"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-y-6 gap-x-8">
                        <div><p class="text-sm text-gray-500 mb-1">التخصص</p><p id="info-spec" class="text-lg font-bold text-gray-800">-</p></div>
                        <div><p class="text-sm text-gray-500 mb-1">السنة الدراسية</p><p id="info-year" class="text-lg font-bold text-gray-800">-</p></div>
                        <div class="col-span-full"><p class="text-sm text-gray-500 mb-1">البريد الإلكتروني الجامعي</p><p id="info-email" class="text-lg font-medium text-gray-700 font-mono">-</p></div>
                        <div class="col-span-full"><p class="text-sm text-gray-500 mb-1">تاريخ الانضمام</p><p id="info-date" class="text-gray-700">-</p></div>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl shadow-lg p-8 text-white relative overflow-hidden">
                    <i class="fas fa-chart-bar absolute -left-4 -bottom-4 text-9xl text-white opacity-5"></i>
                    <h3 class="text-xl font-bold mb-2">تحليلات الأداء (ميزة مستقبلية)</h3>
                    <p class="text-gray-400 text-sm mb-6 max-w-md">نعمل على ربط ملفك بنتائج الامتحانات لتقديم رسوم بيانية تظهر تقدمك الدراسي.</p>
                    <div class="absolute inset-0 flex items-center justify-center z-10"><span class="bg-yellow-500 text-black px-3 py-1 rounded-full text-xs font-bold shadow-lg">قريباً</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-black/60 z-[100] hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl mx-auto transform transition-all scale-100">
            <div class="flex justify-between items-center mb-6 border-b pb-3">
                <h3 class="text-xl font-bold text-gray-800">تحديث البيانات الأكاديمية</h3>
                <button type="button" id="close-modal-btn" class="text-gray-400 hover:text-gray-600 transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <form id="update-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">التخصص الجامعي</label>
                    <div class="relative">
                        <select id="input-spec" class="w-full border border-gray-300 rounded-xl px-4 py-3 bg-gray-50 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition appearance-none mb-2">
                            <option value="طب بشري">طب بشري</option>
                            <option value="طب بشري واعلام آلي">طب بشري واعلام آلي</option>
                            <option value="طب أسنان">طب أسنان</option>
                            <option value="صيدلة">صيدلة</option>
                            <option value="شبه طبي">شبه طبي</option>
                            <option value="بيولوجيا">بيولوجيا</option>
                            <option value="other">تخصص آخر (أكتبه يدوياً)</option>
                        </select>
                        <div class="absolute top-4 left-0 flex items-center px-3 pointer-events-none text-gray-500"><i class="fas fa-chevron-down text-xs"></i></div>
                        
                        <input type="text" id="input-spec-other" placeholder="اكتب تخصصك هنا..." class="hidden w-full border border-gray-300 rounded-xl px-4 py-3 bg-gray-50 focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">السنة الدراسية</label>
                    <div class="relative">
                        <select id="input-year" class="w-full border border-gray-300 rounded-xl px-4 py-3 bg-gray-50 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition appearance-none">
                            <option value="السنة الأولى">السنة الأولى</option>
                            <option value="السنة الثانية">السنة الثانية</option>
                            <option value="السنة الثالثة">السنة الثالثة</option>
                            <option value="السنة الرابعة">السنة الرابعة</option>
                            <option value="السنة الخامسة">السنة الخامسة</option>
                            <option value="السنة السادسة">السنة السادسة</option>
                            <option value="إمتياز / تخرج">إمتياز / تخرج</option>
                        </select>
                        <div class="absolute inset-y-0 left-0 flex items-center px-3 pointer-events-none text-gray-500"><i class="fas fa-chevron-down text-xs"></i></div>
                    </div>
                </div>

                <div class="flex gap-3 mt-8">
                    <button type="submit" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition flex items-center justify-center gap-2 shadow-lg shadow-indigo-200">
                        <span id="save-btn-text">حفظ التغييرات</span>
                        <div id="save-loader" class="hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDAEbxYuAHu5stGx5c02VbgsUKBhoidTeA",
            authDomain: "informationpassmemberessystem.firebaseapp.com",
            projectId: "informationpassmemberessystem",
            storageBucket: "informationpassmemberessystem.appspot.com",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ImgBB Upload Function
        async function uploadImageToImgBB(file) {
            const formData = new FormData();
            formData.append('image', file);
            formData.append('key', "ac296feb5a275923598bdbfd4f9aed8c");
            const response = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: formData });
            if (!response.ok) throw new Error(`فشل الرفع`);
            const result = await response.json();
            if (result.success) return result.data.url;
            else throw new Error(result.error.message);
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const userRef = doc(db, 'users', user.uid);
                    const userSnap = await getDoc(userRef);
                    if (userSnap.exists()) {
                        renderProfile(userSnap.data(), user);
                    } else {
                        renderProfile({}, user);
                    }
                    const q = query(collection(db, 'student_contributions'), where('uid', '==', user.uid));
                    const snapshot = await getDocs(q);
                    document.getElementById('contrib-count').textContent = snapshot.size;
                    document.getElementById('page-loader').classList.add('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                } catch (e) {
                    console.error(e);
                    Swal.fire({icon: 'error', title: 'خطأ', text: 'حدث خطأ في تحميل البيانات'});
                }
            } else {
                window.location.href = 'login_contect_user_system_med.html';
            }
        });

        function renderProfile(data, userAuth) {
            document.getElementById('user-name').textContent = data.displayName || data.name || 'مستخدم';
            document.getElementById('info-email').textContent = userAuth.email;
            document.getElementById('info-spec').textContent = data.specialization || 'غير محدد';
            document.getElementById('info-year').textContent = data.year || 'غير محدد';
            
            if(data.registrationDate) {
                const date = data.registrationDate.toDate ? data.registrationDate.toDate() : new Date(data.registrationDate);
                document.getElementById('info-date').textContent = date.toLocaleDateString('ar-EG');
            }

            const imgEl = document.getElementById('profile-img');
            if (data.photoUrl) {
                imgEl.src = data.photoUrl;
            } else {
                imgEl.src = `https://ui-avatars.com/api/?name=${data.displayName || 'User'}&background=random&size=150`;
            }
        }

        // --- Toggle for "Other" Specialization ---
        const specSelect = document.getElementById('input-spec');
        const otherInput = document.getElementById('input-spec-other');

        specSelect.addEventListener('change', function() {
            if (this.value === 'other') {
                otherInput.classList.remove('hidden');
                otherInput.required = true;
            } else {
                otherInput.classList.add('hidden');
                otherInput.required = false;
            }
        });

        // --- Modal Logic ---
        const editModal = document.getElementById('edit-modal');
        const editBtn = document.getElementById('edit-info-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const updateForm = document.getElementById('update-form');
        const saveLoader = document.getElementById('save-loader');
        const saveBtnText = document.getElementById('save-btn-text');

        editBtn.addEventListener('click', () => {
            const currentSpec = document.getElementById('info-spec').textContent;
            const currentYear = document.getElementById('info-year').textContent;
            const yearSelect = document.getElementById('input-year');

            // Handle Specialization Logic
            const options = Array.from(specSelect.options).map(o => o.value);
            // If current spec is in standard options, select it. Else, set "other" and fill input.
            if (options.includes(currentSpec)) {
                specSelect.value = currentSpec;
                otherInput.classList.add('hidden');
            } else {
                specSelect.value = 'other';
                otherInput.value = currentSpec;
                otherInput.classList.remove('hidden');
            }

            // Handle Year Logic
            if([...yearSelect.options].some(o => o.value === currentYear)) {
                 yearSelect.value = currentYear;
            }

            editModal.classList.remove('hidden');
        });

        const closeModal = () => editModal.classList.add('hidden');
        closeModalBtn.addEventListener('click', closeModal);
        editModal.addEventListener('click', (e) => { if (e.target === editModal) closeModal(); });

        updateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            saveLoader.classList.remove('hidden');
            saveBtnText.textContent = 'جاري الحفظ...';
            
            // Determine Final Specialization
            const selectVal = specSelect.value;
            const otherVal = otherInput.value;
            const newSpec = (selectVal === 'other') ? otherVal : selectVal;
            
            const newYear = document.getElementById('input-year').value;
            
            try {
                const uid = auth.currentUser.uid;
                await updateDoc(doc(db, 'users', uid), {
                    specialization: newSpec,
                    year: newYear
                });

                document.getElementById('info-spec').textContent = newSpec;
                document.getElementById('info-year').textContent = newYear;

                closeModal();
                Swal.fire({
                    position: 'center', icon: 'success', title: 'تم التحديث!',
                    text: 'تم تحديث بياناتك الأكاديمية بنجاح.', showConfirmButton: false, timer: 1500,
                    background: '#ffffff', customClass: { popup: 'rounded-2xl shadow-lg' }
                });

            } catch (error) {
                console.error("Error updating profile:", error);
                Swal.fire({icon: 'error', title: 'خطأ', text: 'حدث خطأ أثناء التحديث'});
            } finally {
                saveLoader.classList.add('hidden');
                saveBtnText.textContent = 'حفظ التغييرات';
            }
        });

        // Image Upload
        document.getElementById('img-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const loader = document.getElementById('upload-loader');
            loader.classList.remove('hidden');
            document.getElementById('profile-img').classList.add('opacity-50');

            try {
                const newUrl = await uploadImageToImgBB(file);
                const uid = auth.currentUser.uid;
                await updateDoc(doc(db, 'users', uid), { photoUrl: newUrl });
                document.getElementById('profile-img').src = newUrl;
                Swal.fire({ position: 'top-end', icon: 'success', title: 'تم تحديث الصورة', showConfirmButton: false, timer: 1500, toast: true });
            } catch (error) {
                console.error(error);
                Swal.fire({ icon: 'error', title: 'فشل الرفع', text: 'حاول مرة أخرى' });
            } finally {
                loader.classList.add('hidden');
                document.getElementById('profile-img').classList.remove('opacity-50');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
    </script>
</body>
</html>