<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª - PRO</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #f3f4f6; }
    /* Ø¥Ø¶Ø§ÙØ© Ø®Ø· ÙƒØ§ÙŠØ±Ùˆ (Cairo) Ù„Ù…Ø¸Ù‡Ø± Ø£ÙØ¶Ù„ */
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
    .li-hover:hover { border-right-color: #4f46e5 !important; background-color: #f1f5f9; }
  </style>
</head>
<body>

  <div id="loader" class="text-center pt-20 text-xl font-semibold text-gray-600">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ©...</div>

  <div id="app-container" class="container hidden max-w-5xl mx-auto p-4 sm:p-6 lg:p-8 bg-gray-50 min-h-screen">
    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
        
        <div class="flex justify-between items-center border-b-2 border-indigo-600 pb-4 mb-6">
            <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 flex items-center gap-3">
                <i class="fas fa-bullhorn text-indigo-600"></i>
                Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            </h2>
            <button id="logoutButton" class="bg-red-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-600 transition duration-200 shadow-md">
                <i class="fas fa-sign-out-alt ml-2"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            </button>
        </div>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 mb-8">
          <input id="notifInput" type="text" placeholder="âœï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§..." class="col-span-full lg:col-span-2 px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
          <input id="notifLink" type="url" placeholder="ğŸ”— Ø§Ù„Ø±Ø§Ø¨Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)..." class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
          <input id="notifIcon" type="text" placeholder="Ø£ÙŠÙ‚ÙˆÙ†Ø© (Ù…Ø«Ù„: fas fa-bullhorn)" value="fas fa-bell" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
          
          <select id="notifColor" title="Ø§Ø®ØªØ± Ù„ÙˆÙ† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±" class="px-4 py-3 border border-gray-300 rounded-lg bg-white focus:ring-indigo-500 focus:border-indigo-500 cursor-pointer transition">
            <option value="text-gray-900">Ø£Ø³ÙˆØ¯ (Ø§ÙØªØ±Ø§Ø¶ÙŠ)</option>
            <option value="text-red-600" class="text-red-600 font-bold">Ø£Ø­Ù…Ø±</option>
            <option value="text-green-600" class="text-green-600 font-bold">Ø£Ø®Ø¶Ø±</option>
            <option value="text-blue-600" class="text-blue-600 font-bold">Ø£Ø²Ø±Ù‚</option>
          </select>
          
          <button id="addButton" class="bg-indigo-600 text-white col-span-full sm:col-span-2 lg:col-span-1 py-3 rounded-lg font-bold hover:bg-indigo-700 transition duration-200 shadow-md">
            â• Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø±
          </button>
        </div>
        
        <ul id="notifList" class="space-y-3">
            <li class="bg-gray-100 p-4 rounded-lg border-r-4 border-gray-300 text-gray-500 font-medium">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª...</li>
        </ul>
    </div>
  </div>

  <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 text-center">
        <i class="fas fa-trash-alt text-red-500 text-4xl mb-4"></i>
        <h3 class="text-xl font-bold mb-2">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
        <p id="delete-text" class="text-gray-600 mb-6">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±ØŸ</p>
        <div class="flex justify-center gap-4">
            <button id="confirmDelete" class="bg-red-600 text-white px-5 py-2 rounded-lg hover:bg-red-700 transition">Ù†Ø¹Ù…ØŒ Ø£Ø­Ø°Ù</button>
            <button id="cancelDelete" class="bg-gray-400 text-white px-5 py-2 rounded-lg hover:bg-gray-500 transition">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ³ (ÙƒÙ…Ø§ ÙÙŠ Ù…Ù„ÙØ§ØªÙƒ Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©)
    const firebaseConfig = {
      apiKey: "AIzaSyAJK6IUSw2YbwNVfB_hRNsOFeO08LEp4c8",
      authDomain: "adatealm-nofication.firebaseapp.com",
      projectId: "adatealm-nofication",
      storageBucket: "adatealm-nofication.appspot.com",
      messagingSenderId: "216068965336",
      appId: "1:216068965336:web:310c95e8e9fc4561cbe8ad",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const notificationsCollection = collection(db, "notifications");
    const loginUrl = "login_TAWASLE_PRO.html"; 

    // --- Auth Guard ---
    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById('loader').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
        initializeAppLogic();
      } else {
        window.location.replace(loginUrl);
      }
    });

    // --- Logic Implementation (Ensures code runs only after authentication) ---
    function initializeAppLogic() {
        const notifList = document.getElementById('notifList');
        const deleteModal = document.getElementById('deleteModal');
        let docToDeleteId = null;

        // --- CRUD Functions ---
        async function addNotification() {
            const text = document.getElementById('notifInput').value.trim();
            const link = document.getElementById('notifLink').value.trim();
            const icon = document.getElementById('notifIcon').value.trim();
            const color = document.getElementById('notifColor').value;

            if (text === "") return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±.");

            try {
                await addDoc(notificationsCollection, {
                    text: text,
                    link: link,
                    icon: icon,
                    color: color,
                    createdAt: serverTimestamp() // Ø¥Ø¶Ø§ÙØ© Ø®ØªÙ… Ø§Ù„ÙˆÙ‚Øª
                });
                document.getElementById('notifInput').value = '';
                document.getElementById('notifLink').value = '';
            } catch (error) {
                console.error("Error adding document: ", error);
            }
        }
        
        async function deleteNotification() {
            if (docToDeleteId) {
                try {
                    await deleteDoc(doc(db, "notifications", docToDeleteId));
                    hideDeleteModal();
                } catch (error) {
                    console.error("Error removing document: ", error);
                }
            }
        }

        async function updateNotification(docId, newText, newLink, newIcon, newColor) {
            try {
                const docRef = doc(db, "notifications", docId);
                await updateDoc(docRef, {
                    text: newText,
                    link: newLink,
                    icon: newIcon,
                    color: newColor
                });
            } catch (error) {
                console.error("Error updating document: ", error);
            }
        }

        // --- Modal/UI Functions ---
        function showDeleteModal(docId, text) {
            docToDeleteId = docId;
            document.getElementById('delete-text').textContent = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±: "${text.substring(0, 40)}..."ØŸ`;
            deleteModal.classList.remove('hidden');
        }

        function hideDeleteModal() {
            deleteModal.classList.add('hidden');
            docToDeleteId = null;
        }

        function toggleEditMode(li, docId, currentData) {
            if (li.querySelector('.edit-container')) {
                // Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ¹Ù„Ø§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„)
                renderNotificationItem(li, docId, currentData);
                return;
            }

            // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            li.innerHTML = `
                <div class="edit-container w-full flex flex-col gap-2">
                    <input type="text" value="${currentData.text}" id="edit-text-${docId}" class="w-full px-3 py-2 border border-indigo-400 rounded-lg text-sm" autofocus>
                    <input type="url" value="${currentData.link || ''}" id="edit-link-${docId}" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    <div class="flex gap-2 justify-end">
                        <button id="save-btn-${docId}" class="bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600">Ø­ÙØ¸</button>
                        <button id="cancel-btn-${docId}" class="bg-gray-400 text-white px-3 py-1 rounded-lg text-sm hover:bg-gray-500">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </div>
            `;
            
            document.getElementById(`cancel-btn-${docId}`).onclick = () => renderNotificationItem(li, docId, currentData);
            document.getElementById(`save-btn-${docId}`).onclick = () => {
                const newText = document.getElementById(`edit-text-${docId}`).value.trim();
                const newLink = document.getElementById(`edit-link-${docId}`).value.trim();
                // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ù„ÙˆÙ† Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
                updateNotification(docId, newText, newLink, currentData.icon, currentData.color);
            };
        }

        function renderNotificationItem(li, docId, data) {
            const date = data.createdAt ? data.createdAt.toDate().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) : 'Ù‚Ø±ÙŠØ¨Ø§Ù‹';
            
            li.className = `bg-white p-4 rounded-lg border-r-4 border-l-4 border-r-indigo-400 border-l-transparent flex justify-between items-start gap-4 shadow-sm transition li-hover ${data.color || 'text-gray-900'}`;
            li.innerHTML = `
                <div class="notif-text flex flex-col items-start w-full">
                    <span class="text-lg font-medium flex items-center gap-2 ${data.color || 'text-gray-900'}">
                        <i class="${data.icon || 'fas fa-bell'} text-indigo-500 ml-2"></i>
                        ${data.text}
                    </span>
                    ${data.link ? `<a href="${data.link}" target="_blank" class="text-sm font-normal text-blue-500 hover:text-blue-700 underline mt-1 break-all transition">ğŸ”— ${data.link}</a>` : ''}
                    <span class="text-xs text-gray-400 mt-2">
                         <i class="fas fa-clock"></i> ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${date}
                    </span>
                </div>
                <div class="action-buttons flex gap-2 flex-shrink-0 mt-1">
                    <button class="edit-btn text-2xl text-indigo-500 hover:text-indigo-700 transition" title="ØªØ¹Ø¯ÙŠÙ„"><i class="fas fa-pen-to-square"></i></button>
                    <button class="delete-btn text-2xl text-red-500 hover:text-red-700 transition" title="Ø­Ø°Ù"><i class="fas fa-trash-alt"></i></button>
                </div>
            `;

            li.querySelector('.edit-btn').onclick = () => toggleEditMode(li, docId, data);
            li.querySelector('.delete-btn').onclick = () => showDeleteModal(docId, data.text);
        }

        // --- Data Listener (Real-time update) ---
        function listenForNotifications() {
            const q = query(notificationsCollection, orderBy("createdAt", "desc"));
            
            onSnapshot(q, (snapshot) => {
                notifList.innerHTML = '';
                if (snapshot.empty) {
                    notifList.innerHTML = '<li class="bg-gray-100 p-4 rounded-lg border-r-4 border-gray-300 text-gray-500 font-medium">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</li>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const li = document.createElement('li');
                    
                    renderNotificationItem(li, doc.id, data);
                    notifList.appendChild(li);
                });
            }, (error) => {
                console.error("Error listening to notifications: ", error);
                notifList.innerHTML = '<li class="text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</li>';
            });
        }

        // --- Event Listeners ---
        listenForNotifications();
        document.getElementById('addButton').onclick = addNotification;
        document.getElementById('logoutButton').onclick = () => signOut(auth);
        document.getElementById('confirmDelete').onclick = deleteNotification;
        document.getElementById('cancelDelete').onclick = hideDeleteModal;
    }
  </script>
</body>
</html>